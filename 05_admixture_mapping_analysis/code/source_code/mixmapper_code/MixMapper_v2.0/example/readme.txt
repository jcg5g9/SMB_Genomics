####################################
###                              ###
###  Example MixMapper workflow  ###
###                              ###
###   Mark Lipson and Po-Ru Loh  ###
###       December 3, 2012       ###
###                              ###
####################################


This example works with data from the Human Origins data set provided
with the ADMIXTOOLS package (Patterson et al., Genetics, 2012).


0. Create a data set in unpacked EIGENSTRAT format.

The MixMapper code works with data in unpacked EIGENSTRAT format
(.ind, .snp, .geno).  Note that EIGENSTRAT .geno files come in two
varieties, however: unpacked (a plain-text file containing allele
counts) and packed (a more space-efficient binary representation).  To
unpack a packed .geno file, use the 'convertf' program provided with
ADMIXTOOLS.

To reduce file size, the sample data provided here is a toy data set
containing just 1% of the Panel 4 (San ascertained) genotype data
provided with ADMIXTOOLS v1.0.  Explicitly, we did the following
(after running convertf to unpack panel4.geno):

sed -n '0~100p' panel4.geno > panel4_thinned.geno
sed -n '0~100p' panel4.snp > panel4_thinned.snp
replaced non-HGDP and San with 'Ignore' in panel4.ind
  -> panel4_only_human_no_San.ind


1. Compute moment statistics on the data set.

./../compute_moment_stats panel4_only_human_no_San.ind panel4_thinned.snp panel4_thinned.geno panel4_thinned_MixMapper n 24 50 > compute_moment_stats_stdout.txt 2> compute_moment_stats_stderr.txt

The command above computes allele frequency moment statistics from 24
bootstrap replicates, bootstrapping over SNPs in 50 blocks across the
genome, but not bootstrapping over individuals used to represent a
population.  Output files have the prefix 'panel4_thinned_MixMapper'.


2. Choose a scaffold tree.

./../compute_most_additive_trees panel4_thinned_MixMapper.f2.tab 10000 compute_moment_stats_stdout.txt required_scaffold_pops.txt > most_additive_trees.txt

The above command computes neighbor joining trees on subsets of
populations from a filtered list of populations
(compute_moment_stats_stdout.txt) containing certain required
populations (required_scaffold_pops.txt).  The trees for which
leaf-to-leaf distances have minimal deviation from measured pairwise
f2 distances are output.

In general, while this process can be performed fully automatically if
desired, we recommend some curation on the part of the user for
several reasons:

- The filtered list of populations produced by compute_moment_stats
  simply eliminates those populations identified as admixed by the
  3-population test (i.e., having one or more significantly negative
  f3 values).  However, the 3-population test is not perfectly
  sensitive; it may make sense to further eliminate some populations
  that are known or believed to be admixed.

- Including more populations in the neighbor joining tree increases
  error but also increases the geographical coverage of the scaffold
  tree, which helps when interpreting results.  It is up to the user
  to decide where to strike the balance, both in terms of the number
  of populations to use and whether to require that particular
  populations be included in the scaffold.

- Typically, several potential scaffold trees have error comparable to
  the tree with minimal error (with the differences being
  statistically insignificant); thus, the list is meant more as a
  guide than a hard ranking.

For all of these reasons we recommend selecting a few possible
scaffolds and trying them each during subsequent admixture fitting to
get a sense of the sensitivity of the results to the choice of
scaffold.


3. Fit admixtures in MATLAB.

See the example code given at the top of the MixMapper.m file, which
carries out mixture fitting on the data generated by the previous
steps of this example.
